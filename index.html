<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thanh To√°n V√© LRC - QR Code</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 800px; 
            margin: 0 auto; 
            padding: 10px;
        }
        h3 { 
            margin-top: 5px;
            margin-bottom: 5px;
            font-size: 1em; 
            font-weight: bold;
        }
        .ticket-form { 
            background: #f9f9f9; 
            padding: 15px;
            border-radius: 8px; 
            margin-bottom: 20px;
        }
        .ticket-group { 
            border: 1px solid #ddd; 
            padding: 10px;
            margin-bottom: 20px; 
            border-radius: 6px; 
        }
        label, select, input, button { 
            display: block; 
            margin-bottom: 15px; 
            width: 100%; 
            box-sizing: border-box; 
        }
        /* Quy t·∫Øc ƒë·ªãnh d·∫°ng chung cho Input, Select */
        input[type="text"], input[type="number"], select { 
            padding: 10px; 
            font-size: 16px;
            font-family: Arial, sans-serif;
            border: 1px solid #ccc; 
            border-radius: 4px; 
        }
        button { 
            background-color: #007bff; 
            color: white; 
            padding: 12px; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
            font-size: 18px; 
            margin-top: 20px; 
        }
        button:hover { 
            background-color: #0056b3; 
        }
        #qr-container { 
            text-align: center; 
            margin-top: 30px; 
            padding: 20px; 
            border-radius: 8px; 
            border: 1px solid #eee;
        }
        #qr-container img {
            max-width: 90%;
            height: auto;
            width: 300px; 
            margin: 20px auto 10px auto;
            display: block;
        }
        #total-amount { 
            font-size: 1.5em; 
            font-weight: bold; 
            color: #28a745; 
            margin-bottom: 15px; 
        }
        
        /* === STYLE KH·ªêI TH√îNG TIN (LI·ªÄN K·ªÄ) === */
        .info-block {
            max-width: 450px;
            margin: 0 auto;
            padding-bottom: 15px;
            text-align: left;
        }
        .info-row { 
            display: flex;
            align-items: center; /* CƒÉn gi·ªØa theo chi·ªÅu d·ªçc */
            margin-bottom: 12px;
            padding: 5px 0;
            border-bottom: 1px dotted #eee;
        }
        /* H√†ng N·ªôi dung: C·∫ßn ph·∫£i cƒÉn tr√™n c√πng (flex-start) */
        .content-row { 
            display: flex;
            align-items: flex-start;
            margin-bottom: 12px;
            padding: 5px 0;
            border-bottom: 1px dotted #eee;
        }
        .info-row label, .content-row label {
            width: 100px;
            margin-bottom: 0;
            font-weight: bold;
            flex-shrink: 0;
            color: #555;
            display: inline;
            padding-top: 0;
        }
        .display-value {
            flex-grow: 1;
            font-weight: bold;
            font-size: 1.05em;
            word-wrap: break-word; 
            white-space: pre-wrap; 
        }
        /* Container ch·ª©a N·ªôi dung Text v√† N√∫t Copy ri√™ng bi·ªát */
        .content-wrapper {
            flex-grow: 1;
            display: flex;
            flex-direction: column; /* X·∫øp n·ªôi dung v√† n√∫t d·ªçc */
            align-items: flex-start; /* N·ªôi dung cƒÉn tr√°i */
        }
        .content-text {
            flex-grow: 1;
            padding-right: 10px;
            word-wrap: break-word;
            white-space: pre-wrap;
            font-size: 1.05em;
            font-weight: bold;
            margin-bottom: 8px; /* Kho·∫£ng c√°ch d∆∞·ªõi n·ªôi dung */
        }

        /* N√∫t Copy */
        .copy-btn {
            background: none;
            color: #007bff;
            border: 1px solid #007bff;
            padding: 8px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            width: auto;
            /* ƒê·∫©y n√∫t ra gi·ªØa (ho·∫∑c cƒÉn tr√°i) d∆∞·ªõi n·ªôi dung */
            align-self: flex-start; 
            margin-bottom: 0; 
        }
        .copy-btn:hover {
            background-color: #e6f0ff;
        }
        .copy-btn i {
            margin-right: 5px;
        }

        #explanation {
            font-size: 0.95em;
            text-align: center;
            padding-top: 10px;
            border-top: 1px dashed #ccc;
            margin-top: 15px;
        }
        .download-button {
            background-color: #f39c12; 
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px auto;
            width: auto;
            display: block;
        }
        .download-button:hover {
            background-color: #e67e22;
        }
        .error { color: red; margin-bottom: 10px; }

        /* Style cho B·∫£ng gi√° v√© */
        .price-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            text-align: left;
            font-size: 0.95em;
        }
        .price-table th, .price-table td {
            border: 1px solid #ddd;
            padding: 8px;
        }
        .price-table th {
            background-color: #007bff;
            color: white;
            text-align: center;
        }
        .price-table tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        .price-value {
            text-align: right;
            font-weight: bold;
            color: #c0392b;
        }
    </style>
</head>
<body>

    <h1>üí∞ Thanh To√°n V√© LRC</h1>
    <hr>

    <div class="ticket-form" style="background: #fff; border: 1px solid #007bff;">
        <h2>B·∫£ng Gi√° V√© (ƒê∆°n v·ªã: VND)</h2>
        <table class="price-table">
            <thead>
                <tr>
                    <th rowspan="2">ƒê·ªëi t∆∞·ª£ng</th>
                    <th colspan="2">H√¨nh th·ª©c ƒëƒÉng k√Ω</th>
                </tr>
                <tr>
                    <th>V√© Theo ƒêo√†n</th> 
                    <th>V√© T·ª± T√∫c</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Ng∆∞·ªùi l·ªõn (NL)</td>
                    <td class="price-value">1.700.000</td>
                    <td class="price-value">1.500.000</td>
                </tr>
                <tr>
                    <td>Tr·∫ª em (TE, 6-10 tu·ªïi)</td>
                    <td class="price-value">1.200.000</td>
                    <td class="price-value">1.000.000</td>
                </tr>
                <tr>
                    <td>Tr·∫ª em ƒëi k√®m (DK, 1-5 tu·ªïi)</td>
                    <td class="price-value">200.000</td>
                    <td class="price-value">0</td>
                </tr>
            </tbody>
        </table>
    </div>
    
    <div class="ticket-form">
        <h2>Th√¥ng tin ƒë·∫∑t v√© v√† ng∆∞·ªùi chuy·ªÉn</h2>

        <label for="name">H·ªç t√™n Lƒê Platinum UP:</label>
        <input type="text" id="name" placeholder="V√≠ d·ª•: NGUYEN VAN A">
        
        <label for="transport_mode">H√¨nh th·ª©c ƒêƒÉng k√Ω:</label>
        <select id="transport_mode">
            <option value="group_only">Ch·ªâ ƒëi theo ƒëo√†n</option>
            <option value="self_only">Ch·ªâ ƒëi t·ª± t√∫c</option>
            <option value="combined">K·∫øt h·ª£p theo ƒëo√†n v√† t·ª± t√∫c</option>
        </select>

        <div id="group-form" class="ticket-group">
            <h3>V√© THEO ƒêO√ÄN</h3>
            <label for="group_adults">S·ªë l∆∞·ª£ng Ng∆∞·ªùi l·ªõn (ƒêo√†n):</label>
            <input type="number" id="group_adults" value="0" min="0">

            <label for="group_children_6_10">S·ªë l∆∞·ª£ng Tr·∫ª em (ƒêo√†n, 6-10 tu·ªïi):</label>
            <input type="number" id="group_children_6_10" value="0" min="0">

            <label for="group_children_1_5">S·ªë l∆∞·ª£ng Tr·∫ª em ƒëi k√®m (ƒêo√†n, 1-5 tu·ªïi):</label>
            <input type="number" id="group_children_1_5" value="0" min="0">
        </div>

        <div id="self-form" class="ticket-group" style="display:none;">
            <h3>V√© T·ª∞ T√öC</h3>
            <label for="self_adults">S·ªë l∆∞·ª£ng Ng∆∞·ªùi l·ªõn (T·ª± t√∫c):</label>
            <input type="number" id="self_adults" value="0" min="0">

            <label for="self_children_6_10">S·ªë l∆∞·ª£ng Tr·∫ª em (T·ª± t√∫c, 6-10 tu·ªïi):</label>
            <input type="number" id="self_children_6_10" value="0" min="0">

            <label for="self_children_1_5">S·ªë l∆∞·ª£ng Tr·∫ª em ƒëi k√®m (T·ª± t√∫c, 1-5 tu·ªïi):</label>
            <input type="number" id="self_children_1_5" value="0" min="0">
        </div>
        
        <div id="total-amount">T·ªïng ti·ªÅn: 0 VND</div>
        
        <button onclick="generateQrCode()">Hi·ªán M√£ QR Thanh To√°n</button>
    </div>

    <div id="qr-container">
        <p>Vui l√≤ng ch·ªçn th√¥ng tin v√© v√† nh·∫•n n√∫t ƒë·ªÉ t·∫°o m√£ QR.</p>
    </div>

    <script>
        // --- H√†m Copy N·ªôi dung ---
        function copyToClipboard(elementId) {
            const copyElement = document.getElementById(elementId);
            
            if (copyElement) {
                const copyText = copyElement.getAttribute('data-value'); 

                if (navigator.clipboard) {
                    navigator.clipboard.writeText(copyText).then(() => {
                        alert("ƒê√£ sao ch√©p: " + copyText);
                    }).catch(err => {
                        console.error('Kh√¥ng th·ªÉ sao ch√©p', err);
                        fallbackCopyToClipboard(copyText);
                    });
                } else {
                    fallbackCopyToClipboard(copyText);
                }
            }
        }
        
        // Ph∆∞∆°ng √°n d·ª± ph√≤ng 
        function fallbackCopyToClipboard(text) {
            const tempInput = document.createElement('textarea');
            tempInput.value = text;
            tempInput.style.position = 'fixed'; 
            tempInput.style.opacity = '0'; 
            document.body.appendChild(tempInput);
            tempInput.focus();
            tempInput.select();
            
            try {
                document.execCommand('copy');
                alert("ƒê√£ sao ch√©p: " + text);
            } catch (err) {
                alert("T·ª± ƒë·ªông sao ch√©p kh√¥ng ho·∫°t ƒë·ªông. Vui l√≤ng sao ch√©p th·ªß c√¥ng: " + text);
            }
            document.body.removeChild(tempInput);
        }

        // --- H√ÄM T·∫¢I ·∫¢NH QR ---
        async function downloadQrCode(qrUrl) {
            if (!qrUrl) {
                 alert("Kh√¥ng t√¨m th·∫•y m√£ QR ƒë·ªÉ t·∫£i v·ªÅ.");
                 return;
            }

            try {
                const response = await fetch(qrUrl);
                const blob = await response.blob();
                const url = URL.createObjectURL(blob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = 'QR_LRC_Thanhtoan.png'; 
                
                document.body.appendChild(link);
                link.click();
                
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
            } catch (error) {
                console.error('Download failed using fetch/blob:', error);
                alert("L·ªói: Kh√¥ng th·ªÉ t·∫£i m√£ QR t·ª± ƒë·ªông. Vui l√≤ng th·ª≠ nh·∫•p chu·ªôt ph·∫£i/gi·ªØ v√†o ·∫£nh ƒë·ªÉ l∆∞u th·ªß c√¥ng.");
            }
        }

        // --- D·ªØ li·ªáu gi√° v√© v√† h√†m logic (Gi·ªØ nguy√™n) ---
        const TICKET_PRICES = {
            group: {
                adult: 1700000,
                child_6_10: 1200000,
                child_1_5: 200000 
            },
            self: {
                adult: 1500000,
                child_6_10: 1000000,
                child_1_5: 0 
            }
        };

        function cleanVietnameseString(str) {
            if (!str) return '';
            str = str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toUpperCase();
            str = str.replace(/[^A-Z0-9\s]/g, ' ');
            return str.replace(/\s+/g, ' ').trim();
        }

        function toggleForms() {
            const mode = document.getElementById('transport_mode').value;
            document.getElementById('group-form').style.display = (mode === 'group_only' || mode === 'combined') ? 'block' : 'none';
            document.getElementById('self-form').style.display = (mode === 'self_only' || mode === 'combined') ? 'block' : 'none';
            calculateTotal(); 
        }

        function calculateTotal() {
            const mode = document.getElementById('transport_mode').value;
            let total = 0;
            let tickets = {};

            if (mode === 'group_only' || mode === 'combined') {
                const ga = parseInt(document.getElementById('group_adults').value) || 0;
                const gc610 = parseInt(document.getElementById('group_children_6_10').value) || 0;
                const gc15 = parseInt(document.getElementById('group_children_1_5').value) || 0;
                total += (ga * TICKET_PRICES.group.adult) + (gc610 * TICKET_PRICES.group.child_6_10) + (gc15 * TICKET_PRICES.group.child_1_5);
                tickets.group = { adults: ga, c610: gc610, c15: gc15 };
            }

            if (mode === 'self_only' || mode === 'combined') {
                const sa = parseInt(document.getElementById('self_adults').value) || 0;
                const sc610 = parseInt(document.getElementById('self_children_6_10').value) || 0;
                const sc15 = parseInt(document.getElementById('self_children_1_5').value) || 0;
                total += (sa * TICKET_PRICES.self.adult) + (sc610 * TICKET_PRICES.self.child_6_10) + (sc15 * TICKET_PRICES.self.child_1_5);
                tickets.self = { adults: sa, c610: sc610, c15: sc15 };
            }

            const totalDisplay = document.getElementById('total-amount');
            totalDisplay.innerHTML = `T·ªïng ti·ªÅn: ${total.toLocaleString('vi-VN')} VND`;
            totalDisplay.dataset.amount = total; 
            totalDisplay.dataset.tickets = JSON.stringify(tickets);
        }

        // --- H√†m t·∫°o URL m√£ QR v√† hi·ªÉn th·ªã ---
        function generateQrCode() {
            calculateTotal(); 

            const totalAmount = document.getElementById('total-amount').dataset.amount;
            const nameInput = document.getElementById('name').value.trim();
            const tickets = JSON.parse(document.getElementById('total-amount').dataset.tickets || '{}');
            
            const qrContainer = document.getElementById('qr-container');

            if (nameInput === "") {
                qrContainer.innerHTML = '<p class="error">‚ö†Ô∏è Vui l√≤ng nh·∫≠p **H·ªç t√™n Lƒê Platinum UP** ƒë·ªÉ t·∫°o m√£ QR.</p>';
                return;
            }
            if (totalAmount == 0) {
                qrContainer.innerHTML = '<p class="error">‚ö†Ô∏è Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt v√©.</p>';
                return;
            }

            // T·∫°o FINAL DESCRIPTION
            const cleanName = cleanVietnameseString(nameInput);
            let descriptionParts = [cleanName];
            
            if (tickets.group && (tickets.group.adults > 0 || tickets.group.c610 > 0 || tickets.group.c15 > 0)) {
                let groupDetails = ['VeDoan'];
                if (tickets.group.adults > 0) groupDetails.push(`${tickets.group.adults}NL`);
                if (tickets.group.c610 > 0) groupDetails.push(`${tickets.group.c610}TE`);
                if (tickets.group.c15 > 0) groupDetails.push(`${tickets.group.c15}DK`); 
                descriptionParts.push(groupDetails.join(' '));
            }
            
            if (tickets.self && (tickets.self.adults > 0 || tickets.self.c610 > 0 || tickets.self.c15 > 0)) {
                let selfDetails = ['TuTuc'];
                if (tickets.self.adults > 0) selfDetails.push(`${tickets.self.adults}NL`);
                if (tickets.self.c610 > 0) selfDetails.push(`${tickets.self.c610}TE`);
                if (tickets.self.c15 > 0) selfDetails.push(`${tickets.self.c15}DK`); 
                descriptionParts.push(selfDetails.join(' '));
            }

            const finalDescription = descriptionParts.join(' '); 
            const encodedDescription = finalDescription.replace(/\s/g, '+');
            const qrUrl = `https://qr.sepay.vn/img?bank=VietinBank&acc=NHILE88&template=compact&amount=${totalAmount}&des=${encodedDescription}`; // L∆∞u URL QR

            const displayAmount = parseInt(totalAmount).toLocaleString('vi-VN');
            const explanationContent = 'NL: Ng∆∞·ªùi l·ªõn | TE: Tr·∫ª em (6-10 tu·ªïi) | DK: Tr·∫ª em ƒëi k√®m (1-5 tu·ªïi) | VeDoan/TuTuc: Lo·∫°i v√© ƒë√£ ƒëƒÉng k√Ω.';

            // --- C·∫•u tr√∫c HTML M·ªöI ---
            qrContainer.innerHTML = `
                <h2>M√£ QR Thanh To√°n</h2>
                <p>Qu√©t m√£ ho·∫∑c sao ch√©p th√¥ng tin:</p>

                <div class="info-block">
                    
                    <div class="info-row">
                        <label>Ng√¢n h√†ng:</label>
                        <span class="display-value">Vietinbank</span>
                    </div>

                    <div class="info-row">
                        <label>Ch·ªß TK:</label>
                        <span id="acc_holder_display" class="display-value" data-value="NHILE88">NHILE88</span>
                    </div>

                    <div class="info-row">
                        <label>S·ªë ti·ªÅn:</label>
                        <span id="amount_box_display" class="display-value" data-value="${totalAmount}">${displayAmount} VND</span>
                    </div>

                    <div class="content-row">
                        <label>N·ªôi dung:</label>
                        
                        <div class="content-wrapper">
                            <span id="des_box" class="content-text" data-value="${finalDescription}">${finalDescription}</span>
                            
                            <button class="copy-btn" onclick="copyToClipboard('des_box')">
                                <i class="fa-regular fa-copy"></i> Copy
                            </button>
                        </div>
                    </div>
                </div>

                <img src="${qrUrl}" alt="M√£ QR Thanh To√°n" id="qr-image">
                
                <button class="download-button" onclick="downloadQrCode('${qrUrl}')">T·∫£i M√£ QR</button>

                <p class="note">Vui l√≤ng ki·ªÉm tra k·ªπ **S·ªë ti·ªÅn** v√† **N·ªôi dung** tr√™n ·ª©ng d·ª•ng ng√¢n h√†ng tr∆∞·ªõc khi x√°c nh·∫≠n.</p>
                
                <div id="explanation">
                    ${explanationContent}
                </div>
            `;
        }

        // --- G·∫Øn s·ª± ki·ªán (Event Listeners) ---
        document.getElementById('transport_mode').addEventListener('change', toggleForms);

        const inputIds = [
            'name', 'group_adults', 'group_children_6_10', 'group_children_1_5',
            'self_adults', 'self_children_6_10', 'self_children_1_5'
        ];
        
        inputIds.forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.addEventListener('change', calculateTotal);
                element.addEventListener('input', calculateTotal);
            }
        });

        // Kh·ªüi t·∫°o ban ƒë·∫ßu
        toggleForms();
    </script>
</body>
</html>
